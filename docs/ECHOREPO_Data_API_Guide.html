<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ECHOREPO Data API (v1) — Integration Guide</title>
  <style>
    :root { --fg:#1f2937; --bg:#ffffff; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; margin: 2rem auto; max-width: 900px; padding: 0 1rem; color: var(--fg); background: var(--bg); }
    h1,h2,h3,h4 { line-height:1.25; }
    h1 { font-size: 2rem; margin-top: 0; }
    h2 { font-size: 1.4rem; margin-top: 2rem; }
    h3 { font-size: 1.15rem; margin-top: 1.5rem; }
    p, li { font-size: 0.98rem; }
    code { background:#f3f4f6; padding: 0.15rem 0.35rem; border-radius: 4px; }
    pre { background:#0b1020; color:#e5e7eb; padding:1rem; border-radius:8px; overflow:auto; }
    pre code { background: transparent; padding: 0; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    ul { padding-left: 1.2rem; }
    hr { border:0; border-top:1px solid var(--border); margin:2rem 0; }
    .meta { color: var(--muted); font-size: 0.9rem; }
  </style>
</head>
<body>
<h1>ECHOREPO Data API (v1) — Integration Guide</h1>

<p>**Base URL:** <code>https://echorepo.quanta-labs.com/api/v1</code>  </p>
<p>**Status:** Stable (versioned). Backward‑compatible additions may occur. Breaking changes will use a new version path (e.g., <code>/api/v2</code>).</p>

<p>---</p>

<h2>1) Authentication</h2>

<p>You must authenticate **every** request using **one** of the methods below.</p>

<h3>Option A — API Key (simple)</h3>
<p>Send the key provided to you by the ECHOREPO team:</p>

<ul>
<li>**Header:** <code>X-API-Key: &amp;lt;your-secret&amp;gt;</code>  </li>
<li>**or** Query parameter: <code>?api_key=&amp;lt;your-secret&amp;gt;</code> (handy for tools that can’t set headers)</li>
</ul>

<p>**Example:**</p>
<pre><code>
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?limit=1&quot;
</code></pre>

<h3>Option B — OAuth2 Client Credentials (Keycloak) (standard)</h3>
<p>Use a confidential client in Keycloak to obtain a bearer token.</p>

<ul>
<li>**Issuer (realm):** <code>https://keycloak-dev.quanta-labs.com/auth/realms/echo_realm</code></li>
<li>**Token endpoint:** <code>.../protocol/openid-connect/token</code></li>
<li>**Client ID (audience):** <code>echorepo-api</code></li>
<li>**Client Secret:** (obtain from ECHO team)</li>
</ul>

<p>**Get a token:**</p>
<pre><code>
TOKEN=$(curl -s -X POST \
  -d &#x27;grant_type=client_credentials&#x27; \
  -d &#x27;client_id=echorepo-api&#x27; \
  -d &#x27;client_secret=YOUR_CLIENT_SECRET&#x27; \
  &#x27;https://keycloak-dev.quanta-labs.com/auth/realms/echo_realm/protocol/openid-connect/token&#x27; \
  | python3 -c &#x27;import sys,json; print(json.load(sys.stdin)[&quot;access_token&quot;])&#x27;)
</code></pre>

<p>**Call the API with the token:**</p>
<pre><code>
curl -H &quot;Authorization: Bearer $TOKEN&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?limit=1&quot;
</code></pre>

<p>&gt; You can also use an authenticated **browser session** to call the API from within the app (not common for machine‑to‑machine integrations).</p>

<p>---</p>

<h2>2) Endpoints</h2>

<h3>`GET /ping`</h3>
<p>Connectivity health check.</p>
<ul>
<li>**200 OK** → <code>{&amp;quot;ok&amp;quot;: true}</code></li>
</ul>

<h3>`GET /samples`</h3>
<p>Retrieve samples with filtering, paging, and output format selection.</p>

<p>**Query parameters:**</p>
<ul>
<li><code>from</code> — Start timestamp (inclusive). Accepts ISO‑like strings: <code>YYYY-MM-DD</code>, <code>YYYY-MM-DDTHH:MM[:SS[.fff]]</code></li>
<li><code>to</code> — End timestamp (inclusive). Same formats as <code>from</code>.</li>
<li><code>bbox</code> — Bounding box (WGS‑84 lon/lat), **<code>west,south,east,north</code>** e.g. <code>-7.5,43.0,-6.5,43.8</code></li>
<li><code>within</code> — Approximate circle filter, **<code>lat,lon,r_km</code>** e.g. <code>43.41,-7.14,25</code></li>
<li><code>fields</code> — Comma list of columns to include, or <code>*</code> for all **non‑excluded** columns.</li>
<li><code>limit</code> — Page size (default <code>100</code>, max <code>1000</code>)</li>
<li><code>offset</code> — Page offset (default <code>0</code>)</li>
<li><code>order</code> — Column to sort by (default <code>collectedAt</code> if present)</li>
<li><code>dir</code> — <code>asc</code> or <code>desc</code> (default <code>desc</code>)</li>
<li><code>format</code> — <code>json</code> (default) | <code>csv</code> | <code>geojson</code></li>
<li><code>api_key</code> — only if you’re sending the API key via query param</li>
</ul>

<p>**Important field policy (privacy &amp; hygiene):**</p>
<p>  <code>sampleId, collectedAt, GPS_long, GPS_lat, PH_ph, SOIL_TEXTURE_texture, SOIL_STRUCTURE_structure, SOIL_DIVER_earthworms, SOIL_CONTAMINATION_plastic</code></p>
<ul>
<li>**Always excluded:** <code>email</code>, <code>userId</code> (PII)</li>
<li>**Always excluded:** any column whose name ends with <code>*_state</code> (e.g., <code>PH_state</code>, <code>PHOTO_state</code>, …)</li>
<li>If you request <code>fields=*</code> or explicitly include excluded columns, they will still be removed.</li>
<li>Default field set (subject to availability):  </li>
</ul>

<p>**Responses:**</p>
<p>  ```json</p>
<p>  {</p>
<p>    &quot;meta&quot;: { &quot;count&quot;: 1234, &quot;limit&quot;: 100, &quot;offset&quot;: 0, &quot;order&quot;: &quot;collectedAt&quot;, &quot;dir&quot;: &quot;desc&quot; },</p>
<p>    &quot;data&quot;: [</p>
<p>      { &quot;sampleId&quot;: &quot;...&quot;, &quot;collectedAt&quot;: &quot;...&quot;, &quot;GPS_long&quot;: -7.1417, &quot;GPS_lat&quot;: 43.4101, &quot;PH_ph&quot;: &quot;pH - 8.5&quot;, ... }</p>
<p>    ]</p>
<p>  }</p>
<p>  ```</p>
<ul>
<li>**JSON** (default):</li>
<li>**CSV**: header = selected fields (excluded columns never appear).</li>
<li>**GeoJSON**: <code>FeatureCollection</code> of <code>Point</code> features; coordinates from <code>GPS_long</code>/<code>GPS_lat</code>; other columns go into <code>properties</code>.</li>
</ul>

<h3>`GET /samples/count`</h3>
<p>Fast count of samples matching date filters.</p>
<ul>
<li>**Query params:** <code>from</code>, <code>to</code></li>
<li>**Response:** <code>{&amp;quot;count&amp;quot;: &amp;lt;integer&amp;gt;}</code></li>
</ul>

<p>---</p>

<h2>3) Examples</h2>

<h3>Last 7 days (JSON)</h3>
<pre><code>
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?from=$(date -I -d &#x27;-7 days&#x27;)&amp;order=collectedAt&amp;dir=desc&amp;limit=100&quot;
</code></pre>

<h3>Bounding box (GeoJSON)</h3>
<pre><code>
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?bbox=-7.5,43.0,-6.5,43.8&amp;format=geojson&quot; \
  -o bbox.geojson
</code></pre>

<h3>CSV export (selected fields)</h3>
<pre><code>
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?fields=sampleId,collectedAt,GPS_lat,GPS_long,PH_ph&amp;format=csv&quot; \
  -o samples.csv
</code></pre>

<h3>Within radius (25 km)</h3>
<pre><code>
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?within=43.41,-7.14,25&amp;format=json&amp;limit=50&quot;
</code></pre>

<h3>Paging</h3>
<pre><code>
# page 1
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?limit=500&amp;offset=0&quot;

# page 2
curl -H &quot;X-API-Key: YOUR_SECRET&quot; \
  &quot;https://echorepo.quanta-labs.com/api/v1/samples?limit=500&amp;offset=500&quot;
</code></pre>

<p>---</p>

<h2>4) Tool-specific notes</h2>

<h3>QGIS</h3>
<p>  <code>https://echorepo.quanta-labs.com/api/v1/samples?bbox=-7.5,43.0,-6.5,43.8&amp;amp;format=geojson&amp;amp;api_key=YOUR_SECRET</code></p>
<ul>
<li>Layer → **Add Layer** → **Add Vector Layer** → Protocol = **HTTP(S)**.</li>
<li>URL (use query param for the key):  </li>
</ul>

<h3>Python (requests + pandas)</h3>
<pre><code>
import os, requests, pandas as pd

BASE = &quot;https://echorepo.quanta-labs.com/api/v1&quot;
KEY  = os.getenv(&quot;API_KEY&quot;, &quot;YOUR_SECRET&quot;)
S    = requests.Session(); S.headers[&quot;X-API-Key&quot;] = KEY

def fetch_all(params):
    out = []
    limit, offset = 500, 0
    while True:
        r = S.get(f&quot;{BASE}/samples&quot;, params={**params, &quot;limit&quot;: limit, &quot;offset&quot;: offset}, timeout=30)
        r.raise_for_status()
        j = r.json()
        out.extend(j[&quot;data&quot;])
        if offset + limit &gt;= j[&quot;meta&quot;][&quot;count&quot;]:
            break
        offset += limit
    return out

rows = fetch_all({&quot;from&quot;:&quot;2025-05-01&quot;,&quot;to&quot;:&quot;2025-07-31&quot;,&quot;order&quot;:&quot;collectedAt&quot;,&quot;dir&quot;:&quot;desc&quot;})
pd.DataFrame(rows).to_csv(&quot;samples_export.csv&quot;, index=False)
</code></pre>

<h3>Excel / Google Sheets</h3>
<p>Use CSV with query param key:</p>
<p>  <code>https://echorepo.quanta-labs.com/api/v1/samples?from=2025-07-01&amp;amp;format=csv&amp;amp;api_key=YOUR_SECRET</code></p>
<p>  <code>=IMPORTDATA(&amp;quot;https://echorepo.quanta-labs.com/api/v1/samples?format=csv&amp;amp;api_key=YOUR_SECRET&amp;quot;)</code></p>
<ul>
<li>Excel: Data → **From Web** →  </li>
<li>Google Sheets:  </li>
</ul>

<p>---</p>

<h2>5) Filters: details &amp; caveats</h2>

<ul>
<li>**Date parsing:** <code>from</code>/<code>to</code> accept <code>YYYY-MM-DD</code>, <code>YYYY-MM-DDTHH:MM[:SS[.fff]]</code> (UTC or naive). They are compared lexicographically; ISO‑8601 sorts correctly.</li>
<li>**<code>bbox</code> vs <code>within</code>:** <code>within</code> uses an **approximate degree window** based on the provided radius and latitude; it’s fast and good for filtering. If you need exact distance (Haversine), ask us to enable an additional precise filter.</li>
<li>**Coordinates:** <code>GPS_long</code> = longitude (x), <code>GPS_lat</code> = latitude (y), WGS‑84 (EPSG:4326).</li>
</ul>

<p>---</p>

<h2>6) Errors</h2>

<p>  Body example: <code>{&amp;quot;message&amp;quot;:&amp;quot;Missing or invalid credentials&amp;quot;}</code> (or an HTML error page)</p>
<ul>
<li>**401 Unauthorized** — Missing/invalid credentials.  </li>
<li>**400 Bad Request** — Malformed parameters (e.g., invalid bbox format)</li>
<li>**404 Not Found** — Wrong path or version</li>
<li>**5xx** — Server error</li>
</ul>

<p>---</p>

<h2>7) Privacy &amp; field policy</h2>

<ul>
<li>**PII** is never returned: <code>email</code>, <code>userId</code></li>
<li>Any column whose name ends with **<code>_state</code>** is never returned.</li>
<li>The default field list avoids personal data; requesting <code>fields=*</code> still respects the exclusions.</li>
</ul>

<p>If your integration requires additional columns, contact the ECHOREPO team to review data‑protection implications.</p>

<p>---</p>

<h2>8) Changelog</h2>

<ul>
<li>**2025‑10‑30** — Initial public documentation for <code>/api/v1</code></li>
</ul>

<p>---</p>

<h2>9) Support / Contact</h2>

<ul>
<li>Technical questions &amp; access: **ECHOREPO team (Quanta Systems S.L.)**</li>
<li>Base URL: <code>https://echorepo.quanta-labs.com/api/v1</code></li>
<li>Keycloak realm: <code>echo_realm</code> (client: <code>echorepo-api</code>)</li>
</ul>

</body>
</html>
