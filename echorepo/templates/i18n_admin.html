{% extends 'base.html' %}
{% block title %}I18N Admin{% endblock %}
{% block content %}
<div class="container my-3">
  <h3>Translation overrides</h3>
  <form class="row g-2 align-items-end mb-3" method="get">
    <div class="col-auto">
      <label class="form-label">Locale</label>
      <select name="locale" class="form-select">
        {% for loc in locales %}
          <option value="{{loc}}"{% if loc==locale %} selected{% endif %}>{{loc}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
      <label class="form-label">Search</label>
      <input class="form-control" name="q" value="{{q or ''}}" placeholder="key or value">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" type="submit">Filter</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr><th style="width:28%">Key</th><th>Override value ({{locale}})</th><th style="width:12%"></th></tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr data-key="{{r.key}}">
          <td class="text-monospace"><code>{{ r.key }}</code></td>
          <td>
            <input class="form-control form-control-sm override-input" value="{{ r.value }}" placeholder="Leave empty to remove override">
          </td>
          <td>
            <button class="btn btn-sm btn-outline-success save-btn">Save</button>
            <button class="btn btn-sm btn-outline-danger clear-btn">Clear</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="alert alert-info">
    Overrides take effect on next page load. They donâ€™t modify PO/MO files.
  </div>
</div>

<script>
(function(){
  const locale = "{{ locale }}";
  async function postJSON(url, payload){
    const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), credentials:'same-origin'});
    if(!r.ok){ const t = await r.text(); throw new Error(t || r.statusText); }
    return r.json();
  }
  document.querySelectorAll('tr[data-key]').forEach(tr=>{
    const key = tr.getAttribute('data-key');
    const input = tr.querySelector('.override-input');
    tr.querySelector('.save-btn').addEventListener('click', async ()=>{
      try{
        await postJSON('/i18n/admin/set', { locale, key, value: input.value });
        input.classList.add('is-valid'); setTimeout(()=>input.classList.remove('is-valid'), 800);
      }catch(e){ alert('Save failed: ' + e.message); }
    });
    tr.querySelector('.clear-btn').addEventListener('click', async ()=>{
      try{
        await postJSON('/i18n/admin/set', { locale, key, value: "" });
        input.value = "";
        input.classList.add('is-valid'); setTimeout(()=>input.classList.remove('is-valid'), 800);
      }catch(e){ alert('Clear failed: ' + e.message); }
    });
  });
})();
</script>
{% endblock %}
