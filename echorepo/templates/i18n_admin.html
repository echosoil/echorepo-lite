{% extends 'base.html' %}
{% block title %}I18N Admin{% endblock %}

{% block content %}
<div class="container my-3">
  <h3>Translation overrides</h3>

  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link {% if scope!='js' and scope!='manual_en' %}active{% endif %}"
         href="{{ url_for('i18n_admin.admin_page',
                          scope='page',
                          locale=locale,
                          file=files_hint or '',
                          q=request.args.get('q','')) }}">
        Page texts
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if scope=='js' %}active{% endif %}"
         href="{{ url_for('i18n_admin.admin_page',
                          scope='js',
                          locale=locale,
                          q=request.args.get('q','')) }}">
        JS keys
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if scope=='manual_en' %}active{% endif %}"
         href="{{ url_for('i18n_admin.admin_page',
                          scope='manual_en',
                          locale=locale,
                          q=request.args.get('q','')) }}">
        Manual EN overrides
      </a>
    </li>
  </ul>

  {# ---------------- Manual EN tab ---------------- #}
  {% if scope == 'manual_en' %}

    <form id="manualFilterForm" class="row g-2 align-items-end mb-3" method="get">
      <input type="hidden" name="scope" value="manual_en">
      <input type="hidden" name="locale" value="{{ locale }}">
      <div class="col-auto">
        <label class="form-label">Search</label>
        <input class="form-control" name="q" value="{{ request.args.get('q','') }}">
      </div>
      <div class="col-auto">
        <label class="form-label d-block">&nbsp;</label>
        <button class="btn btn-primary">Filter</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width:45%">Original text (from *_orig)</th>
            <th style="width:45%">Override EN</th>
            <th style="width:10%"></th>
          </tr>
        </thead>
        <tbody id="manualOverridesBody">
        {% for r in rows %}
          <tr>
            <td>
              <code class="orig-text">{{ r.orig }}</code>
            </td>
            <td>
              <input class="form-control form-control-sm manual-override-input"
                     value="{{ r.override }}">
            </td>
            <td>
              <button class="btn btn-sm btn-outline-success manual-save-btn">Save</button>
              <button class="btn btn-sm btn-outline-danger manual-clear-btn">Clear</button>
            </td>
          </tr>
        {% endfor %}

          {# add-new row #}
          <tr>
            <td>
              <input id="newOrig"
                     class="form-control form-control-sm"
                     placeholder="New original text (exact match)">
            </td>
            <td>
              <input id="newOverride"
                     class="form-control form-control-sm"
                     placeholder="New EN override">
            </td>
            <td>
              <button id="btnAddManualOverride"
                      class="btn btn-sm btn-outline-primary">
                Add
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="alert alert-info mt-3">
      These overrides are applied <strong>before</strong> automatic translation into English
      for canonical Postgres fields (e.g. <code>contamination_other_en</code>,
      <code>soil_texture_en</code>, etc.).
    </div>

  {# ---------------- Original Page / JS tabs ---------------- #}
  {% else %}

    <form id="filterForm" class="row g-2 align-items-end mb-3" method="get">
      <input type="hidden" name="scope" value="{{ scope }}">

      <div class="col-auto">
        <label class="form-label">Locale</label>
        <select class="form-select" name="locale" id="localeSelect">
          {% for code in SUPPORTED_LOCALES %}
            <option value="{{ code }}" {% if code==locale %}selected{% endif %}>
              {{ code }}
            </option>
          {% endfor %}
        </select>
      </div>

      {% if scope!='js' %}
      <div class="col-auto">
        <label class="form-label">Filter by file (e.g. base.html, map.js)</label>
        <input class="form-control" name="file" value="{{ files_hint or '' }}">
      </div>
      {% endif %}

      <div class="col-auto">
        <label class="form-label">Search</label>
        <input class="form-control" name="q" value="{{ request.args.get('q','') }}">
      </div>

      <div class="col-auto">
        <label class="form-label d-block">&nbsp;</label>
        <button class="btn btn-primary">Filter</button>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
        {% if scope=='js' %}
          <tr>
            <th style="width:18%">Key</th>
            <th>English msgid</th>
            <th>Current</th>
            <th style="width:32%">Override</th>
            <th style="width:10%"></th>
          </tr>
        {% else %}
          <tr>
            <th>Msgid (English)</th>
            <th>Current</th>
            <th style="width:32%">Override</th>
            <th style="width:10%"></th>
          </tr>
        {% endif %}
        </thead>
        <tbody>
        {% for r in rows %}
          <tr>
            {% if scope=='js' %}
              <td><code>{{ r.key }}</code></td>
              <td>{{ r.msgid }}</td>
            {% else %}
              <td>
                <div class="small text-muted">
                  {% if r.refs %}<div class="text-muted">{{ r.refs|join(', ') }}</div>{% endif %}
                </div>
                {{ r.msgid }}
              </td>
            {% endif %}
            <td>{{ r.current }}</td>
            <td>
              <input class="form-control form-control-sm override-input"
                     value="{{ r.override }}" placeholder="Leave empty to remove override">
            </td>
            <td>
              <button class="btn btn-sm btn-outline-success save-btn">Save</button>
              <button class="btn btn-sm btn-outline-danger clear-btn">Clear</button>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="alert alert-info mt-3">
      Overrides take effect on next page load. They donâ€™t modify PO/MO files.
    </div>

  {% endif %}
</div>

<script>
(function(){
  const scope  = "{{ scope }}";
  const locale = "{{ locale }}";

  // ---------- Page / JS tabs (existing behaviour) ----------
  if (scope !== "manual_en") {
    const form = document.getElementById('filterForm');
    const sel  = document.getElementById('localeSelect');

    if (form && sel) {
      sel.addEventListener('change', () => form.submit());
    }

    async function postJSON(url, payload){
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        credentials:'same-origin'
      });
      if(!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }

    document.querySelectorAll('table tbody tr').forEach(tr=>{
      const input = tr.querySelector('.override-input');
      const save  = tr.querySelector('.save-btn');
      const clear = tr.querySelector('.clear-btn');

      if (!input || !save || !clear) return;

      let payload = { locale };
      if (scope === 'js') {
        const keyCell = tr.querySelector('td code');
        if (keyCell) payload.key = keyCell.textContent.trim();
      } else {
        const cell = tr.querySelector('td');
        if (cell) {
          const parts = cell.innerText.split('\n').map(s=>s.trim()).filter(Boolean);
          payload.msgid = parts[parts.length-1];
        }
      }

      save.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        try {
          await postJSON('/i18n/admin/set', Object.assign({}, payload, {value: input.value}));
          input.classList.add('is-valid');
          setTimeout(()=>input.classList.remove('is-valid'), 600);
        } catch(e){ alert('Save failed: ' + e.message); }
      });

      clear.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        try {
          await postJSON('/i18n/admin/set', Object.assign({}, payload, {value: ""}));
          input.value="";
          input.classList.add('is-valid');
          setTimeout(()=>input.classList.remove('is-valid'), 600);
        } catch(e){ alert('Clear failed: ' + e.message); }
      });
    });

    return; // don't run manual_en code
  }

  // ---------- Manual EN tab logic ----------
  const tbody   = document.getElementById('manualOverridesBody');
  const newOrig = document.getElementById('newOrig');
  const newOv   = document.getElementById('newOverride');
  const btnAdd  = document.getElementById('btnAddManualOverride');

  async function postManual(orig, value){
    const r = await fetch('/i18n/admin/manual_set', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify({orig: orig, value: value})
    });
    if (!r.ok) {
      throw new Error(await r.text());
    }
    return r.json();
  }

  // Existing rows
  if (tbody) {
    tbody.querySelectorAll('tr').forEach(tr=>{
      const origEl = tr.querySelector('.orig-text');
      const input  = tr.querySelector('.manual-override-input');
      const save   = tr.querySelector('.manual-save-btn');
      const clear  = tr.querySelector('.manual-clear-btn');

      if (!origEl || !input || !save || !clear) return;
      const origText = origEl.textContent.trim();

      save.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        try {
          await postManual(origText, input.value);
          input.classList.add('is-valid');
          setTimeout(()=>input.classList.remove('is-valid'), 600);
        } catch(e) {
          alert('Save failed: ' + e.message);
        }
      });

      clear.addEventListener('click', async (ev)=>{
        ev.preventDefault();
        try {
          await postManual(origText, "");
          // simplest: clear the row's input; you can also remove the row
          input.value = "";
          input.classList.add('is-valid');
          setTimeout(()=>input.classList.remove('is-valid'), 600);
        } catch(e) {
          alert('Clear failed: ' + e.message);
        }
      });
    });
  }

  // Add-new row
  if (btnAdd && newOrig && newOv) {
    btnAdd.addEventListener('click', async (ev)=>{
      ev.preventDefault();
      const o = newOrig.value.trim();
      const v = newOv.value.trim();
      if (!o || !v) {
        alert('Please fill both original text and EN override.');
        return;
      }
      try {
        await postManual(o, v);
        // easiest: reload so the new row appears in correct sorted position
        window.location.reload();
      } catch(e) {
        alert('Add failed: ' + e.message);
      }
    });
  }
})();
</script>
{% endblock %}
