{% extends 'base.html' %}
{% block title %}{{ _('ECHOrepo — Explore') }}{% endblock %}

{% block extra_css %}
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        crossorigin="">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">

  <style>
    #map {
      height: 75vh;
      min-height: 500px;
      border-radius: 12px;
      overflow: hidden;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">{{ _('Explore the map') }}</h1>
    {% if not g.user %}
      <div class="alert alert-info small">
        {{ _('Sign in to export data and access your personal samples.') }}
      </div>
    {% endif %}

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('web.search_samples') }}">
        {{ _('Search') }}
      </a>
    </div>
  </div>

  <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
    <span class="text-muted small">{{ _('pH') }}</span>

    <input type="number" step="0.1" min="0" max="14"
          id="phMin"
          class="form-control form-control-sm"
          placeholder="{{ _('min') }}"
          style="width:5.5rem">

    <span class="text-muted">–</span>

    <input type="number" step="0.1" min="0" max="14"
          id="phMax"
          class="form-control form-control-sm"
          placeholder="{{ _('max') }}"
          style="width:5.5rem">

    <button class="btn btn-sm btn-outline-secondary"
            id="btnApplyFilter"
            type="button">
      {{ _('Apply') }}
    </button>

    <button class="btn btn-sm btn-outline-primary"
            id="btnExportFiltered"
            type="button"
            {% if not g.user %}
              hidden
            {% else %}
              disabled
            {% endif %}>
      {{ _('Export filtered (0)') }}
    </button>
  </div>


  <div id="map" class="mb-3"></div>
{% endblock %}

{% block extra_js %}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  {% set cfg = {
      'jitter_m': jitter_m|default(1000)|int,
      'lat_col': lat_col|default('GPS_lat'),
      'lon_col': lon_col|default('GPS_long')
  } %}
<script>
window.ECHOREPO_CFG = Object.assign({}, window.ECHOREPO_CFG || {}, {
  public_mode: true,
  geojson_user_url: null,
  geojson_others_url: "/public/others_geojson"
});
</script>
<script>
  if (window.ECHOREPO_CFG?.public_mode) {
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnExportFiltered');
      if (btn) {
        btn.disabled = true;
        btn.title = "{{ _('Sign in to export data') }}";
      }
    });
  }
</script>
  <script src="{{ url_for('static', filename='js/map.js') }}?v=8"></script>
{% endblock %}
